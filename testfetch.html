<html>
        <div id="inputContainer" style="display: none;">
            <label for="fileInput">Load Bocce Team Schedule:</label>
			<input type="file" id="fileInput">
        </div>

<div id="fileStatus"></div>
<textarea id="output" placeholder="Extracted lines will appear here..."></textarea>
<style>
		body { font-family: sans-serif; padding: 20px; }
		textarea { width: 100%; height: 300px; margin-top: 10px; white-space: pre-wrap; }
		button { margin-top: 10px; }
</style>		

<script>
attempts = [];

const fileInput = document.getElementById('fileInput');
const fileStatus = document.getElementById('fileStatus');

async function checkFileExists(filename) {
  try {
    const response = await fetch(`https://kmcurley.github.io/workspace/${encodeURIComponent(filename)}`);
    const result = await response.json();
	console.log(`result.exists=${result.exists}`);
    if (result.exists) {
      fileInput.disabled = true;
      fileStatus.textContent = `Using server-side file: ${filename}`;
      // Optionally trigger logic to load/process that file
    } else {
      fileInput.disabled = false;
      fileStatus.textContent = 'Please upload a file.';
	  document.getElementById('scheduleContainer').style.display = 'flex';
    }
  } catch (err) {
    console.error('Error checking file:', err);
    fileStatus.textContent = 'Error checking file status.';
    fileInput.disabled = false;
  }
}

// Robust-ish CSV parser supporting quoted fields with commas/newlines inside quotes.
function parseCSV(text){
  // Return array of rows; first row is header.
  // Implement state machine
  const rows = [];
  let cur = [];
  let field = '';
  let i=0;
  const len = text.length;
  let inQuotes = false;
  while(i < len){
    const ch = text[i];
    if(inQuotes){
      if(ch === '"'){
        if(text[i+1] === '"'){ field += '"'; i += 2; continue; } // escaped quote
        else { inQuotes = false; i++; continue; }
      } else {
        field += ch;
        i++;
        continue;
      }
    } else {
      if(ch === '"'){ inQuotes = true; i++; continue; }
      if(ch === ','){ cur.push(field); field = ''; i++; continue; }
      if(ch === '\r'){
        // ignore, handle on \n
        i++; continue;
      }
      if(ch === '\n'){
        cur.push(field);
        rows.push(cur);
        cur = [];
        field = '';
        i++;
        continue;
      }
      field += ch;
      i++;
    }
  }
  // flush
  if(inQuotes){
    // malformed but flush anyway
    cur.push(field);
    rows.push(cur);
  } else {
    if(field !== '' || cur.length > 0){
      cur.push(field);
      rows.push(cur);
    }
  }
  return rows;
}

// ----------------- Loading CSV -----------------
function tryLoadFile(url){
  (async function trySequential(){
    //const url = csvFile;
	console.log(`url(${url})`);
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error('fetch failed ' + res.status);
      const text = await res.text();
	  inputContainer.disabled = true;
      fileStatus.textContent = `Using server-side file: ${csvFile}`;
	  const rows = parseCSV(text);
	  console.log(rows);
	  output.value = rows.join('\n');
      return;
    } catch(e){
	  console.log(`tryLoadFile error: ${e}`);	
      const isHidden = inputContainer.style.display === 'none';
	  inputContainer.style.display = isHidden ? 'block' : 'none';
      fileStatus.textContent = 'Please upload a file.';
      return;
    }
  })();
}

// ----------------- Loading CSV -----------------
function tryAutoLoadFile(csvFile){
  attempts.push(csvFile); // maybe includes .csv

  // attempt fetch sequentially until one ok
  (async function trySequential(idx=0){
    if(idx >= attempts.length){
      // no success; leave UI able to paste or select file
	  console.log('attempts done.  Load a local file.');
	  const isHidden = inputContainer.style.display === 'none';
	  inputContainer.style.display = isHidden ? 'block' : 'none';

      //inputContainer.disabled = false;
	  //fileInput.disabled = false;
      fileStatus.textContent = 'Please upload a file.';
      return;
    }
    const url = attempts[idx];
	console.log(`url(${url})`);
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error('fetch failed ' + res.status);
      const text = await res.text();
	  inputContainer.disabled = true;
      fileStatus.textContent = `Using server-side file: ${csvFile}`;
	  const rows = parseCSV(text);
	  console.log(rows);
	  //renderCSV(rows);
      return;
    } catch(e){
      // try next
      trySequential(idx+1);
    }
  })();
}

  fileInput.addEventListener('change', (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const text = e.target.result;
      console.log(text);
	  const lines = text.split(/\r?\n/);
	  output.value = lines.join('\n');	
    };
    reader.readAsText(f);
  });

console.log("Calling checkFileExists...");
//checkFileExists('schedule.csv'); // Replace with dynamic filename if needed
tryLoadFile('bocce-schedule-2025.csv');
</script>

</html>
